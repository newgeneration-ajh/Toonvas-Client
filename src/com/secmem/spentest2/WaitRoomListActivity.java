package com.secmem.spentest2;

import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.util.ArrayList;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.ImageButton;
import android.widget.ListView;
import android.widget.Toast;

import com.secmem.network.MobileClient;
import com.secmem.packet.PacketData;
import com.secmem.packet.PacketType;
import com.secmem.packet.RecvThread;
import com.secmem.packet.SendManager;
import com.secmem.room.WaitRoomAdapter;
import com.secmem.room.WaitRoomData;
import com.secmem.room.WaitRoomListData;
import com.secmem.spentest2.canvas.CanvasActivity;

public class WaitRoomListActivity extends Activity implements OnItemClickListener, OnClickListener {

	private ListView lv_room;
	private ImageButton btn_startRoom;
	private WaitRoomAdapter adapter;
	private ArrayList<WaitRoomData> roomList;
	private Context m_context = null;
	private String m_roomNum = null;
	private byte m_RoomNumArray[] = null;
	
	//방 정보
	private String roomNum;
	private String id;
	
	/** Called when the activity is first created. */ // this is a example? -_-??
	@Override
	public void onCreate(Bundle savedInstanceState) {
	    super.onCreate(savedInstanceState);
	
	    setContentView(R.layout.activity_wait_room);
	    
	    btn_startRoom = (ImageButton) findViewById(R.id.btn_wait_start);
	    btn_startRoom.setOnClickListener(this);
	    	    
	    lv_room = (ListView) findViewById(R.id.lv_wait_room);
	    lv_room.setOnItemClickListener(this);
	    
	    roomList = new ArrayList<WaitRoomData>();
	    
	    adapter = new WaitRoomAdapter(this, R.layout.item_list_wait_room, roomList);
	    
	    
	    m_context = this;
	    
//	    RecvThread.setHandler(m_Handler);
	    
	    lv_room.setAdapter(adapter);
	     
	    //패킷타입 바꾸고~
//	    PacketData tmpData = new PacketData(PacketType.REQ_ROOMLIST,  null , 0);
//	    SendManager.pushQueue(tmpData);
	    
	    Intent i = getIntent();
	    m_roomNum = i.getExtras().getString("roomNum");
	    id = i.getExtras().getString("ID");
	    
		WaitRoomData data = new WaitRoomData(id);
		adapter.insertItem(data);
		
		RecvThread.setHandler(m_Handler);
		
		ByteBuffer tmpBuffer = ByteBuffer.allocate(4);
	    tmpBuffer.order(ByteOrder.LITTLE_ENDIAN);
	    tmpBuffer.putInt( Integer.parseInt( m_roomNum ) );
	    m_RoomNumArray = tmpBuffer.array();
		
		PacketData sendPacket = new PacketData(PacketType.REQ_ROOM_ID_LIST, m_RoomNumArray, m_RoomNumArray.length);
		
		SendManager.pushQueue(sendPacket);
	}

	protected void onDestroy() {
		MobileClient.getInstance().CloseClient();
		super.onDestroy();
	};
	
	@Override
	protected void onResume() {
		// TODO Auto-generated method stub
		super.onResume();
		RecvThread.setHandler(m_Handler);
	}
	
	@Override
	public void onItemClick(AdapterView<?> view, View arg1, int pos, long arg3) {
		
		
	}
 
	@Override
	public void onClick(View view) {
		switch(view.getId()) {
		case R.id.btn_wait_start :
			
			ByteBuffer tmpBuffer = ByteBuffer.allocate(4);
			
			tmpBuffer.order(ByteOrder.LITTLE_ENDIAN);
			
			tmpBuffer.putInt(Integer.parseInt(m_roomNum));
			
			tmpBuffer.flip();
			
			PacketData tmpData = new PacketData(PacketType.REQ_ROOMSTART, tmpBuffer.array() , 4);
			
			SendManager.pushQueue(tmpData);
			
		} 
	}
	  
	@SuppressLint("HandlerLeak")
	final Handler m_Handler = new Handler() {
		@Override
		public void handleMessage(android.os.Message msg) {
			if ( msg.what == PacketType.RET_ROOMSTART)
			{
				Intent drawAcitivity = new Intent(m_context, CanvasActivity.class);
				
				//임시 룸 번호 - 그리기 엑티비티에 방번호를 넘길 예정
				String tmpRoomNum = m_roomNum;
				drawAcitivity.putExtra("roomNum", tmpRoomNum);
				startActivity(drawAcitivity);
			}
			else if ( msg.what == PacketType.RET_ROOM_ID_LIST )
			{
				WaitRoomListData tmpData = new WaitRoomListData( msg.getData() );
				for ( int i = 0 ; i < 2 ; i++ )
				{
					if ( !id.equals(tmpData.m_Name[i] ) )
					{
						
						adapter.insertItem( new WaitRoomData( tmpData.m_Name[i] ));
					}
				}
			}
		};
	};

}
